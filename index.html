<!DOCTYPE html>
<html lang="en">

<head>
    <title>CS448B Assignment 4</title>

    <!-- Meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="public/css/main.css">

    <!-- D3 -->
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <!-- Map from mapbox -->
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.css" rel="stylesheet" />

    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

    <!-- Imports -->
    <script src="public/js/classes/DataReader.js"></script>
    <script src="public/js/classes/Visualizer.js"></script>
    <script src="https://cdn.rawgit.com/Keyang/node-csvtojson/d41f44aa/browser/csvtojson.min.js"></script>

</head>

<body>

    <!-- Data loading View Start -->
    <!-- <div class="data-container-wrapper" v-if="!isVisualize"> -->
    <div class="sidebar" id='app'>
        <div class="sidebar-content" v-if="!isVisualize">
            <div v-for="(num, index) in numDataFields" class="form-group data-container">
                <div style="display: flex; flex-direction: row; justify-content: center;">
                    <input class="form-control-file csv-file-input" type="file" :id="'input-'+index">
                    <button v-if="headers[index].length == 0" type="button" class="btn btn-outline-secondary"
                        v-on:click="loadData" :name="'input-'+index">Load
                        Data</button>
                </div>
                <div style="display: flex; flex-direction: row; justify-content: center;">
                    <div class="headers headers-required" style="display: flex; flex-direction: column;">
                        <div class="centered">
                            <label for="required-headers"
                                v-if="headers[index] && headers[index].length > 0">Required</label>
                        </div>
                        <div class="headers-row" name="required-headers"
                            v-if="headers[index] && headers[index].length > 0" v-for="req in requiredHeaders">
                            <label class="headers-label">
                                {{ req }}
                            </label>
                            <select v-if="req !== 'title'" @change="handleSelect" :id="'dataDropDown'+num+'-'+req"
                                class="btn dropdown-toggle headers-select" v-model="headerMappings[index][req]"
                                :name="'select-'+index">
                                <div class="dropdown-menu" :aria-labelledby="'dataDropDown'+num+'-'+req">
                                    <option class="dropdown-item headers-select-option" disabled value="">
                                        <template>
                                            Please select
                                        </template>
                                    </option>
                                    <option class="dropdown-item headers-select-option"
                                        v-for="header in getFilteredHeaders(index)" :key="header">
                                        {{ header }}
                                    </option>
                                </div>
                            </select>
                            <input v-else type="text" v-model="headerMappings[index]['title']" id="" name="lname"
                                class="headers-select"
                                style="width: 142px; height: 37px; border: 1px solid grey; border-radius: .25rem; text-align: center;">
                        </div>
                    </div>

                    <div class="headers headers-required" style="display: flex; flex-direction: column; height: 196px;">
                        <div class="centered">
                            <label for="optional-headers"
                                v-if="headers[index] && headers[index].length > 0">Optional</label>
                        </div>
                        <div class="headers-row" name="optional-headers"
                            v-if="headers[index] && headers[index].length > 0" v-for="opt in optionalHeaders">
                            <label class="headers-label">
                                {{ opt }}
                            </label>
                            <select @change="handleSelect" :id="'dataDropDown'+num+'-'+opt"
                                class="btn dropdown-toggle headers-select" v-model="headerMappingsOpt[index][opt]"
                                :name="'select-'+index">
                                <div class="dropdown-menu" :aria-labelledby="'dataDropDown'+num+'-'+opt">
                                    <option class="dropdown-item headers-select-option" value="">
                                    </option>
                                    <option class="dropdown-item headers-select-option"
                                        v-for="header in getFilteredHeaders(index)" :key="header">
                                        {{ header }}
                                    </option>
                                </div>
                            </select>
                        </div>
                    </div>



                </div>
            </div>
            <div class="data-container-control">
                <button v-if="numDataFields !== 3 " type="button" class="btn btn-outline-secondary"
                    v-on:click="handleAddDataSet">Add another data set</button>
                <button v-if="numDataFields > 1 " type="button" class="btn btn-outline-secondary"
                    v-on:click="clearDataAtLastIndex">Remove last data set</button>
                <button v-on:click="handleVisualize" v-if="mappingsComplete" type="button"
                    class="btn btn-outline-secondary data-control-button">Visualize!</button>
            </div>
        </div>
        <div class="sidebar-content" v-if="isVisualize">
            {{'Current time : '+new Date(sharedState.virtualTime).toString()}}
            <div class="event-display-container">
                <event-display v-for="event in sharedState.displayedEvent0" v-bind:key="event.startDate"
                    v-bind:event="event">
                </event-display>
            </div>
            <div class="event-display-container">
                <event-display v-for="event in sharedState.displayedEvent1" v-bind:key="event.startDate"
                    v-bind:event="event">
                </event-display>
            </div>
            <div class="event-display-container">
                <event-display v-for="event in sharedState.displayedEvent2" v-bind:key="event.startDate"
                    v-bind:event="event">
                </event-display>
            </div>
        </div>
    </div>

    <!-- Data loading View End -->

    <!-- Visualization view start-->
    <!-- <div id='map-view' v-if="isVisualize"> -->
    <!-- <div id='map-view'> -->
    <!-- Radio buttons for skins (temporary) -->
    <!-- <div id="menu">
                <input id="light-v10" type="radio" name="rtoggle" value="light" checked="checked" />
                <label for="light">light</label>
                <input id="dark-v10" type="radio" name="rtoggle" value="dark" />
                <label for="dark">dark</label>
                <input id="satellite-v9" type="radio" name="rtoggle" value="satellite" />
                <label for="satellite">satellite</label>
            </div> -->

    <!-- Radio buttons to toggle clearing functionality (temporary) -->
    <!-- <div id="clearToggle">
                <input id="removeOldEvents" type="radio" name="rtoggle" value="true" checked="checked" />
                <label for="removeOldEvents">clear</label>
                <input id="dontRemoveOldEvents" type="radio" name="rtoggle" value="false" />
                <label for="dontRemoveOldEvents">stack</label>
            </div> -->

    <!-- Pane for debug info (temporary) -->
    <!-- <div id='debug'>
                <label id="debugPane">Debug info:</label>
            </div> -->
    <!-- </div> -->
    <!-- Visualization view end-->

    <div id="map"></div>

    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

    <!-- Custom JS -->
    <script src="public/js/bundle.js"></script>
</body>

<script>

    var store = {
        debug: true,
        state: {
            virtualTime: null,
            displayedEvent0: [],
            displayedEvent1: [],
            displayedEvent2: []
        },
        set(newKey, newValue) {
            if (this.debug) console.log('set triggered with', newValue)
            this.state[newKey] = newValue
        },
        get(key) {
            return this.state[key];
        }
    }

    var dataReader = new DataReader();
    var visualizer = new Visualizer(store);
    var isDataSetsAvailable = false;
    visualizer.init();

    var app = new Vue({
        el: '#app',
        data: {
            requiredHeaders: ['title', 'dateStart', 'latitude', 'longitude'],
            optionalHeaders: ['dateEnd', 'description'],
            numDataFields: 1,
            headers: [[], [], []],
            headerMappings: [{}, {}, {}],
            headerMappingsOpt: [{}, {}, {}],    // Optional header mappings
            mappingsComplete: false,
            isVisualize: false,
            sharedState: store.state
        },
        methods: {
            clearDataAtLastIndex: function (index) {
                this.headers[this.numDataFields - 1] = [];
                this.headerMappings[this.numDataFields - 1] = {};
                this.headerMappingsOpt[this.numDataFields - 1] = {};
                this.numDataFields--;
                dataReader.unsetFileContentByKey(`input-${this.numDataFields - 1}`);
            },
            getFilteredHeaders: function (index) {
                return this.headers[index];
            },
            loadData: function (event) {
                let id = event.target.name;
                let index = parseInt(event.target.name.match(/-(.*)/g)[0].slice(1));

                dataReader.readFileAsString(id).then(
                    fileContent => {
                        console.log('Headers : ' + dataReader.getHeaders(id));
                        this.headers[index].length = 0;
                        dataReader.getHeaders(id).forEach(header => {
                            this.headers[index].push(header);
                            console.log('pushing ' + header + ' to index ' + index);

                        });
                    },
                    err => {
                        console.log(err);
                    }
                );
            },
            handleAddDataSet: function () {
                this.numDataFields++;
                this.checkMapping();
            },
            handleSelect: function (event) {
                this.checkMapping();
            },
            checkMapping: function () {
                try {
                    for (let i = 0; i < this.numDataFields; i++) {
                        this.requiredHeaders.forEach(req => {
                            if (this.headerMappings[i][req] === undefined) {
                                throw 'Mappings incomplete.';
                            }
                        });
                    }
                    this.mappingsComplete = true;
                    console.log('mappings complete!');
                } catch (err) {
                    this.mappingsComplete = false;
                }
            },
            handleVisualize: function (event) {
                this.isVisualize = true;
                let promises = [];

                for (let i = 0; i < this.numDataFields; i++) {
                    let headers = this.headers[i];
                    let headerMapping = this.headerMappings[i];
                    let headerMappingOpt = this.headerMappingsOpt[i];
                    let id = `input-${i}`;
                    for (var newHeader in headerMapping) {
                        let oldHeader = headerMapping[newHeader];

                        headers = headers.map(header => {
                            if (header === oldHeader) return newHeader;
                            return header;
                        });
                    }

                    for (var newHeader in headerMappingOpt) {
                        let oldHeader = headerMappingOpt[newHeader];

                        headers = headers.map(header => {
                            if (header === oldHeader) return newHeader;
                            return header;
                        });
                    }

                    dataReader.setHeaders(headers, id);
                    promises.push(dataReader.getJSONFromFile(id, ['title', 'dateStart', 'latitude', 'longitude']));
                }

                let self = this;
                Promise.all(promises).then(async jsonResults => {
                    // Data has been fully parsed. Do something.
                    console.log(dataReader.getJsonResults());
                    await visualizer.init();
                    let tempTitle = 0

                    let strToMs = function (dateStr) {
                        const date = new Date(dateStr);
                        return date.getTime();    // FIXME: would fail if < 1970
                    };

                    console.log(self.state);


                    visualizer.startAnimation(jsonResults.map(result => {
                        return {
                            title: result[0].title,
                            numPoints: result.length,
                            dateRangeMs: [
                                strToMs(result[0].dateStart),
                                strToMs(result[result.length - 1].dateStart)
                            ],
                            data: result
                        }
                    }), self.state);
                    isDataSetsAvailable = true;
                });
            }
        }
    });

    Vue.component('event-display', {
        props: ['event'],
        template:
            `<div>
            <div v-if='event.dateEnd'>
                <h3>
                    {{event.dateStart}} - {{event.dateEnd}}
                </h3>
            </div>
            <div v-else>
                <h3>{{event.dateStart}}</h3>
            </div>

            <h4>
                {{event.title}}
            </h4>

            <div v-if='event.description'>
                <p>
                    {{event.description}}
                </p>
            </div>
        </div>`
    })
</script>

</html>