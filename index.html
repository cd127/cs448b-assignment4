<!DOCTYPE html>
<html lang="en">

<head>
    <title>CS448B Assignment 4</title>

    <!-- Meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <!-- D3 -->
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <!-- Map from mapbox -->
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.8.0/mapbox-gl.css" rel="stylesheet" />

    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

    <!-- Font Awesome -->
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
        integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    <!-- Imports -->
    <script src="public/js/classes/DataReader.js"></script>
    <script src="public/js/classes/Visualizer.js"></script>
    <script src="https://cdn.rawgit.com/Keyang/node-csvtojson/d41f44aa/browser/csvtojson.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="public/css/main.css">
</head>

<body>

    <!-- Side Pane -->
    <div class="sidebar" id='app'>
        
        <!-- Data loading View Start -->
        <div class="sidebar-content" v-if="!isVisualize">
            <div v-for="(num, index) in numDataFields" class="form-group data-container">
                <div style="display: flex; flex-direction: row; justify-content: center;" v-if="headers[index].length == 0">
                    <input class="form-control-file csv-file-input" type="file" :id="'input-'+index">
                    <button type="button" class="btn btn-outline-secondary"
                        v-on:click="loadData" :name="'input-'+index">Load Data</button>
                </div>
                
                <div style="display: flex; flex-direction: row;">
                    <div class="headers headers-required" style="display: flex; flex-direction: column;">
                        <div>
                            <label for="required-headers"
                                v-if="headers[index] && headers[index].length > 0">Required</label>
                        </div>
                        <div class="headers-row" name="required-headers"
                            v-if="headers[index] && headers[index].length > 0" v-for="req in requiredHeaders">
                            <label class="headers-label">
                                {{ req }}
                            </label>
                            <select v-if="req !== 'title'" @change="handleSelect" :id="'dataDropDown'+num+'-'+req"
                                class="btn dropdown-toggle headers-select" v-model="headerMappings[index][req]"
                                :name="'select-'+index">
                                <div class="dropdown-menu" :aria-labelledby="'dataDropDown'+num+'-'+req">
                                    <option class="dropdown-item headers-select-option" disabled value="">
                                        <template>
                                            Please select
                                        </template>
                                    </option>
                                    <option class="dropdown-item headers-select-option"
                                        v-for="header in getFilteredHeaders(index)" :key="header">
                                        {{ header }}
                                    </option>
                                </div>
                            </select>
                            <input v-else type="text" v-model="headerMappings[index]['title']" id="" name="lname"
                                class="headers-select"
                                style="width: 142px; height: 37px; border: 1px solid grey; border-radius: .25rem; text-align: center;">
                        </div>
                    </div>

                    <div class="headers headers-required" style="display: flex; flex-direction: column; height: 196px;">
                        <div>
                            <label for="optional-headers"
                                v-if="headers[index] && headers[index].length > 0">Optional</label>
                        </div>
                        <div class="headers-row" name="optional-headers"
                            v-if="headers[index] && headers[index].length > 0" v-for="opt in optionalHeaders">
                            <label class="headers-label">
                                {{ opt }}
                            </label>
                            <select @change="handleSelect" :id="'dataDropDown'+num+'-'+opt"
                                class="btn dropdown-toggle headers-select" v-model="headerMappingsOpt[index][opt]"
                                :name="'select-'+index">
                                <div class="dropdown-menu" :aria-labelledby="'dataDropDown'+num+'-'+opt">
                                    <option class="dropdown-item headers-select-option" value="">
                                    </option>
                                    <option class="dropdown-item headers-select-option"
                                        v-for="header in getFilteredHeaders(index)" :key="header">
                                        {{ header }}
                                    </option>
                                </div>
                            </select>
                        </div>
                    </div>
                    
                </div>
            </div>

            <div class="data-container-control" style="position:absolute; bottom:10px;">
                <div class="headers-row">
                    <label class="headers-label" style="width:150px;">Duration (minutes):</label>
                    <input type="text" class="headers-select" id='visDuration' value="3"
                        style="width: 142px; height: 37px; border: 1px solid grey; border-radius: .25rem; text-align: center;">
                </div>

                <button v-if="numDataFields !== 3 " type="button" class="btn btn-outline-secondary"
                    v-on:click="handleAddDataSet">Add another dataset</button>
                <button v-if="numDataFields > 1 " type="button" class="btn btn-outline-secondary"
                    v-on:click="clearDataAtLastIndex">Remove last dataset</button>

                <button v-on:click="handleVisualize" v-if=" isDebug || mappingsComplete" type="button"
                    class="btn btn-outline-secondary data-control-button">Visualize!</button>
            </div>

            <div class="btn-group-vertical map-type-group" aria-label="..." v-if="!isVisualize">
                <button type="button map-type" class="btn btn-secondary" onclick="visualizer.mapShowLight()">light</button>
                <button type="button map-type" class="btn btn-secondary" onclick="visualizer.mapShowDark()">dark</button>
                <button type="button map-type" class="btn btn-secondary" onclick="visualizer.mapShowSatellite()">satellite</button>
            </div>
        </div>
        <!-- Data loading View End -->
        
        <!-- Runtime information -->
        <div class="sidebar-content" v-if="isVisualize">
            <!-- Time -->
            <div class="sidebar-controls-container">
                <div class="progress" style="height:20px; width: 100%;">
                    <div id="progress" class="progress-bar bg-secondary" style="height:20px; width:0%;"
                        v-bind:style="{ 'width': sharedState.progress }">
                    </div>
                </div>
                <div>{{'Start time : ' + getStartDate()}}</div>
                <div>{{'Current time : ' + getCurrentDate()}}</div>
                <div>{{'End time : ' + getEndDate()}}</div>

                <div class="sidebar-controls-buttons" style="display: flex;">
                    <button v-on:click="playToggle()" v-if="isPaused">
                        <i class="fa fa-play fa-2x"></i>
                    </button>
                    <button v-on:click="playToggle()" v-if="!isPaused">
                        <i class="fa fa-pause fa-2x" ></i>
                    </button>

                    <button v-on:click="multiplySpeed(0.5)">
                        <i class="fa fa-step-forward fa-2x" aria-hidden="true"></i>
                    </button>
                    <button v-on:click="multiplySpeed(1.5)">
                        <i class="fa fa-fast-forward fa-2x" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
            
            <!-- Event cards -->
            <div class="event-display-container">
                <event-display v-for="(event, index) in sharedState.displayedEvent0" v-bind:key="event.startDate"
                    v-bind:event="event" v-bind:secondaryclass="'event-display-1'"
                    v-if="index == sharedState.displayedEvent0.length-1">
                </event-display>
            </div>
            <div class="event-display-container">
                <event-display v-for="(event, index) in sharedState.displayedEvent1" v-bind:key="event.startDate"
                    v-bind:event="event" v-bind:secondaryclass="'event-display-2'"
                    v-if="index == sharedState.displayedEvent1.length-1">
                </event-display>
            </div>
            <div class="event-display-container">
                <event-display v-for="(event, index) in sharedState.displayedEvent2" v-bind:key="event.startDate"
                    v-bind:event="event" v-bind:secondaryclass="'event-display-3'"
                    v-if="index == sharedState.displayedEvent2.length-1">
                </event-display>
            </div>
        </div>
    </div>

    <!-- Data loading View End -->

    <div id="map"></div>


    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
</body>

<script>

    var store = {
        debug: true,
        state: {
            virtualTime: null,
            displayedEvent0: [],
            displayedEvent1: [],
            displayedEvent2: [],
            speed: 1
        },
        set(newKey, newValue) {
            this.state[newKey] = newValue
        },
        get(key) {
            return this.state[key];
        }
    }

    var dataReader = new DataReader();
    var visualizer = new Visualizer(store);
    var isDataSetsAvailable = false;
    visualizer.init();

    var app = new Vue({
        el: '#app',
        data: {
            requiredHeaders: ['title', 'event', 'dateStart', 'latitude', 'longitude'],
            optionalHeaders: ['description', 'location', 'dateEnd'],
            numDataFields: 1,
            headers: [[], [], []],
            headerMappings: [{}, {}, {}],
            headerMappingsOpt: [{}, {}, {}],    // Optional header mappings
            mappingsComplete: false,
            isVisualize: false,
            isPaused: false,
            isDebug: true,
            store: store,
            sharedState: store.state
        },
        methods: {
            getStartDate: function() {
                if (!this.sharedState.hasOwnProperty('isYearOnly')) return '';
                if (this.sharedState.isYearOnly) return new Date(this.sharedState.startTime).getUTCFullYear();
                return new Date(this.sharedState.startTime).toUTCString();
            },
            getCurrentDate: function() {
                if (!this.sharedState.hasOwnProperty('isYearOnly')) return '';
                if (this.sharedState.isYearOnly) return new Date(this.sharedState.virtualTime).getUTCFullYear();
                return new Date(this.sharedState.virtualTime).toUTCString();
            },
            getEndDate: function() {
                if (!this.sharedState.hasOwnProperty('isYearOnly')) return '';
                if (this.sharedState.isYearOnly) return new Date(this.sharedState.endTime).getUTCFullYear();
                return new Date(this.sharedState.endTime).toUTCString();
            },
            clearDataAtLastIndex: function (index) {
                this.headers[this.numDataFields - 1] = [];
                this.headerMappings[this.numDataFields - 1] = {};
                this.headerMappingsOpt[this.numDataFields - 1] = {};
                this.numDataFields--;
                dataReader.unsetFileContentByKey(`input-${this.numDataFields - 1}`);
            },
            getFilteredHeaders: function (index) {
                return this.headers[index];
            },
            loadData: function (event) {
                let id = event.target.name;
                let index = parseInt(event.target.name.match(/-(.*)/g)[0].slice(1));

                dataReader.readFileAsString(id).then(
                    fileContent => {
                        const headers = dataReader.getHeaders(id);
                        console.log('Headers : ' + headers);
                        this.headers[index].length = 0;
                        headers.forEach(header => {
                            this.headers[index].push(header);
                            console.log('pushing ' + header + ' to index ' + index);

                            <!-- Automatically match fields which are named as we expect -->
                            if (this.requiredHeaders.find(d => d === header))
                            {
                                this.headerMappings[index][header] = header;
                            }
                            if (this.optionalHeaders.find(d => d === header))
                            {
                                this.headerMappingsOpt[index][header] = header;
                            }
                        });
                        this.headerMappings[index]['title'] = document.getElementById(id).files[0].name;
                        this.checkMapping();
                    },
                    err => {
                        console.log(err);
                    }
                );
            },
            handleAddDataSet: function () {
                this.numDataFields++;
                this.checkMapping();
            },
            handleSelect: function (event) {
                this.checkMapping();
            },
            checkMapping: function () {
                try {
                    for (let i = 0; i < this.numDataFields; i++) {
                        this.requiredHeaders.forEach(req => {
                            if (this.headerMappings[i][req] === undefined) {
                                if (!( ((req === "longitude") || (req === "latitude")) // It's ok if 'location' has been filled out
                                        && (this.headerMappingsOpt[i]['location'] != undefined))) {
                                    throw 'Mappings incomplete.';
                                }
                            }
                        });
                    }
                    this.mappingsComplete = true;
                    console.log('mappings complete!');
                } catch (err) {
                    this.mappingsComplete = false;
                }
            },
            playToggle()
            {
                this.store.set('speed', -1 * this.store.get('speed'));
                this.isPaused = !this.isPaused;
            },
            multiplySpeed: function (multiplier = 1.25) {
                let speed = this.store.get('speed');
                if (speed === 0) {
                    this.store.set('speed', 1);
                    return;
                }
                this.store.set('speed', speed * multiplier);
            },
            handleVisualize: function (event) {
                this.isVisualize = true;
                let self = this;
                let promises = [];
                const desiredRuntimeMs = document.getElementById('visDuration').value * 60 * 1000;

                let startAnimation = function (jsonDataArray, datasetNames) {
                    let strToMs = function (dateStr) {
                        const date = new Date(dateStr);
                        return date.getTime();
                    };
                    visualizer.startAnimation(jsonDataArray.map((data, idx) => {
                        // Sort data by start date
                        data.sort((a,b) =>
                            (a.dateStart === b.dateStart) ? 0 :
                            (new Date(a.dateStart) < new Date(b.dateStart)) ? -1 : 1);
                        return {
                            title: datasetNames[idx],
                            numPoints: data.length,
                            dateRangeMs: [
                                strToMs(data[0].dateStart),
                                data[0].hasOwnProperty('dateEnd')?
                                    strToMs(Math.max(...data.map(d => new Date(d.dateEnd).getTime()))) :
                                    strToMs(data[data.length - 1].dateStart)
                            ],
                            data: data
                        }
                    }), desiredRuntimeMs);
                    isDataSetsAvailable = true;
                }

                if (!this.mappingsComplete && this.isDebug) {
                    Promise.all([
                        dataReader.getJSONFromURL('/public/data/chicago-battery-aggravated.csv'),
                        dataReader.getJSONFromURL('/public/data/chicago-assault-aggravated.csv'),
                        dataReader.getJSONFromURL('/public/data/chicago-assault-nonaggravated.csv')
                    ]).then((resultsArray) => {
                        const datasetNames = ['chicago-battery-aggravated',
                                              'chicago-assault-aggravated',
                                              'chicago-assault-nonaggravated'];
                        startAnimation(resultsArray, datasetNames);
                    })
                    return;
                }

                let datasetNames = [];
                for (let i = 0; i < this.numDataFields; i++) {
                    let id = `input-${i}`;
                    promises.push(dataReader.getJSONFromFile(id, {...this.headerMappings[i], ...this.headerMappingsOpt[i]}));
                    let datasetName = this.headerMappings[i]['title'];
                    if (!datasetName)
                        datasetName = document.getElementById(id).files[0].name;
                    datasetNames.push(datasetName);
                }

                Promise.all(promises).then(async jsonResults => {
                    // Data has been fully parsed. Do something.
                    await visualizer.init();
                    startAnimation(jsonResults, datasetNames);
                });
            }
        }
    });

    Vue.component('event-display', {
        props: ['event', 'secondaryclass'],
        template:
            `
        <div v-bind:class="['event-display', secondaryclass]">
            <p class="event-title">{{event.event}}</p>
            <p class="event-datasetName">{{event.datasetName}}</p>

            <p class="event-time">{{event.dateStart}}</p>
            <p class="event-time" style="top: 15px;" v-if='event.dateEnd'>-{{event.dateEnd}}</p>

            <p class="event-description" v-if='event.description'>{{event.description}}</p>
        </div>`
    })
</script>

</html>